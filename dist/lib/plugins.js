// Generated by CoffeeScript 2.7.0
var CWD, consola, executePlugins, fs, getCompiledFiles, path, runPlugins;

path = require('path');

fs = require('fs');

consola = require('consola');

({CWD} = require('./constants'));

({getCompiledFiles} = require('./utils'));

executePlugins = function(config, compilationResult) {
  var plugins, ref;
  plugins = ((ref = config.milkee) != null ? ref.plugins : void 0) || [];
  if (!(plugins.length > 0)) {
    return;
  }
  consola.start(`Running ${plugins.length} plugin(s)...`);
  return (async function() {    // async
    var error, i, len, pluginFn;
    try {
      for (i = 0, len = plugins.length; i < len; i++) {
        pluginFn = plugins[i];
        if (typeof pluginFn === 'function') {
          await Promise.resolve(pluginFn(compilationResult));
        } else {
          consola.warn(`Invalid plugin definition skipped (expected a function, got ${typeof pluginFn}).`);
        }
      }
      return consola.success('Plugins executed successfully.');
    } catch (error1) {
      error = error1;
      return consola.error('An error occurred during plugin execution:', error);
    }
  })();
};

runPlugins = function(config, options, stdout = '', stderr = '') {
  var compilationResult, compiledFiles, mapPath, outputPath;
  outputPath = path.join(CWD, config.output);
  compiledFiles = getCompiledFiles(outputPath);
  if (options.join && options.map && !options.inlineMap) {
    mapPath = `${outputPath}.map`;
    if (fs.existsSync(mapPath && !compiledFiles.includes(mapPath))) {
      compiledFiles = compiledFiles.concat(getCompiledFiles(mapPath));
    }
  }
  compilationResult = {
    config: config,
    compiledFiles: compiledFiles,
    stdout: stdout,
    stderr: stderr
  };
  return executePlugins(config, compilationResult);
};

module.exports = {runPlugins};
