// Generated by CoffeeScript 2.7.0
var CONFIG_FILE, CWD, PLUGIN_KEYWORDS, TEMPLATES, TEMPLATE_DIR, confirmContinue, consola, copyTemplate, ensureDir, execSync, fs, initPackageJson, path, plugin, updatePackageJson,
  indexOf = [].indexOf;

fs = require('fs');

path = require('path');

({execSync} = require('child_process'));

consola = require('consola');

({CWD, CONFIG_FILE} = require('../constants'));

confirmContinue = require('../options/confirm');

TEMPLATE_DIR = path.join(__dirname, '..', '..', 'temp', 'plugin');

TEMPLATES = [
  {
    src: 'main.coffee',
    dest: 'src/main.coffee'
  },
  {
    src: 'coffee.config.cjs',
    dest: CONFIG_FILE
  },
  {
    src: 'publish.yml',
    dest: '.github/workflows/publish.yml'
  },
  {
    src: '.gitignore',
    dest: '.gitignore'
  },
  {
    src: '.gitattributes',
    dest: '.gitattributes'
  },
  {
    src: '.npmignore',
    dest: '.npmignore'
  }
];

// Create directory if not exists
ensureDir = function(filePath) {
  var dir;
  dir = path.dirname(filePath);
  if (!fs.existsSync(dir)) {
    return fs.mkdirSync(dir, {
      recursive: true
    });
  }
};

// Copy template file
copyTemplate = function(src, dest) {
  var content, destPath, srcPath;
  srcPath = path.join(TEMPLATE_DIR, src);
  destPath = path.join(CWD, dest);
  if (!fs.existsSync(srcPath)) {
    consola.error(`Template file not found: ${srcPath}`);
    return false;
  }
  ensureDir(destPath);
  content = fs.readFileSync(srcPath, 'utf-8');
  fs.writeFileSync(destPath, content);
  consola.success(`Created \`${dest}\``);
  return true;
};

PLUGIN_KEYWORDS = ['milkee', 'coffeescript', 'coffee', 'ext', 'plugin', 'milkee-plugin'];

// Update package.json
updatePackageJson = function() {
  var base, error, i, keyword, len, pkg, pkgPath;
  pkgPath = path.join(CWD, 'package.json');
  try {
    pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));
    // Update main
    pkg.main = 'dist/main.js';
    // Update scripts
    if (pkg.scripts == null) {
      pkg.scripts = {};
    }
    if ((base = pkg.scripts).test == null) {
      base.test = 'echo "Error: no test specified" && exit 0';
    }
    pkg.scripts.build = 'milkee';
    // Update keywords
    if (pkg.keywords == null) {
      pkg.keywords = [];
    }
    for (i = 0, len = PLUGIN_KEYWORDS.length; i < len; i++) {
      keyword = PLUGIN_KEYWORDS[i];
      if (indexOf.call(pkg.keywords, keyword) < 0) {
        pkg.keywords.push(keyword);
      }
    }
    fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
    consola.success("Updated `package.json`");
    return true;
  } catch (error1) {
    error = error1;
    consola.error("Failed to update package.json:", error);
    return false;
  }
};

// Initialize package.json if not exists
initPackageJson = function() {
  var error, pkgPath;
  pkgPath = path.join(CWD, 'package.json');
  if (!fs.existsSync(pkgPath)) {
    consola.start("Initializing package.json...");
    try {
      execSync('npm init -y', {
        cwd: CWD,
        stdio: 'inherit'
      });
      consola.success("Created `package.json`");
    } catch (error1) {
      error = error1;
      consola.error("Failed to create package.json:", error);
      return false;
    }
  }
  return true;
};

// Main plugin setup function
plugin = async function() {
  var confirmed, destPath, error, i, j, len, len1, overwrite, pkgPath, template;
  consola.box("Milkee Plugin Setup");
  consola.info("This will set up your project as a Milkee plugin.");
  consola.info("");
  consola.info("The following actions will be performed:");
  pkgPath = path.join(CWD, 'package.json');
  if (!fs.existsSync(pkgPath)) {
    consola.info("  0. Initialize package.json (npm init -y)");
  }
  consola.info("  1. Install dependencies (consola, coffeescript, milkee)");
  consola.info("  2. Create template files:");
  for (i = 0, len = TEMPLATES.length; i < len; i++) {
    template = TEMPLATES[i];
    consola.info(`     - ${template.dest}`);
  }
  consola.info("  3. Update package.json (main, scripts, keywords)");
  consola.info("");
  // Confirm before proceeding
  confirmed = (await confirmContinue());
  if (!confirmed) {
    return;
  }
  consola.info("");
  // Initialize package.json if not exists
  if (!initPackageJson()) {
    return;
  }
  try {
    // Install dependencies
    consola.start("Installing dependencies...");
    execSync('npm install consola', {
      cwd: CWD,
      stdio: 'inherit'
    });
    execSync('npm install -D coffeescript milkee', {
      cwd: CWD,
      stdio: 'inherit'
    });
    consola.success("Dependencies installed!");
  } catch (error1) {
    error = error1;
    consola.error("Failed to install dependencies:", error);
    return;
  }
  consola.info("");
  // Create template files
  consola.start("Creating template files...");
  for (j = 0, len1 = TEMPLATES.length; j < len1; j++) {
    template = TEMPLATES[j];
    destPath = path.join(CWD, template.dest);
    if (fs.existsSync(destPath)) {
      overwrite = (await consola.prompt(`${template.dest} already exists. Overwrite?`, {
        type: "confirm"
      }));
      if (!overwrite) {
        consola.info(`Skipped \`${template.dest}\``);
        continue;
      }
    }
    copyTemplate(template.src, template.dest);
  }
  consola.info("");
  // Update package.json
  consola.start("Updating package.json...");
  updatePackageJson();
  consola.info("");
  consola.success("Milkee plugin setup complete!");
  consola.info("");
  consola.info("Next steps:");
  consola.info("  1. Edit `src/main.coffee` to implement your plugin");
  consola.info("  2. Run `npm run build` to compile");
  return consola.info("  3. Test your plugin locally");
};

module.exports = plugin;
