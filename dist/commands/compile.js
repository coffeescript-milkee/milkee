// Generated by CoffeeScript 2.7.0
var CONFIG_FILE, CONFIG_PATH, CWD, checkCoffee, checkLatest, checkVersion, clearBackups, compile, confirmContinue, consola, crypto, exec, executeCopy, executeRefresh, fs, path, restoreBackups, runPlugins, spawn;

fs = require('fs');

path = require('path');

crypto = require('crypto');

({spawn, exec} = require('child_process'));

consola = require('consola');

({CWD, CONFIG_PATH, CONFIG_FILE} = require('../lib/constants'));

({checkLatest, checkCoffee} = require('../lib/checks'));

({runPlugins} = require('../lib/plugins'));

confirmContinue = require('../options/confirm');

({executeRefresh, restoreBackups, clearBackups} = require('../options/refresh'));

executeCopy = require('../options/copy');

// async
checkVersion = async function() {
  var action, cl, installCmd;
  cl = (await checkLatest());
  if (cl) {
    action = (await consola.prompt('Do you want to update now?', {
      type: 'select',
      options: [
        {
          label: 'No (Skip)',
          value: 'skip',
          hint: 'Start compiling directly'
        },
        {
          label: 'Yes (Global)',
          value: 'global',
          hint: 'npm i -g milkee@latest'
        },
        {
          label: 'Yes (Local)',
          value: 'local',
          hint: 'npm i -D milkee@latest'
        }
      ]
    }));
    if (action && action !== 'skip') {
      installCmd = action === 'global' ? 'npm i -g milkee@latest' : 'npm i -D milkee@latest';
      consola.start('Updating milkee...');
      await new Promise(function(resolve) {
        var cp;
        cp = spawn(installCmd, {
          shell: true,
          stdio: 'inherit'
        });
        return cp.on('close', resolve);
      });
      consola.success('Update finished! Please run the command again.');
      return process.exit(0);
    } else if (action === 'skip') {
      return consola.info('Skipped!');
    } else if (!action) {
      return process.exit(1);
    }
  }
};

// async
compile = async function() {
  var backupFiles, compilerProcess, config, debounceTimeout, enabledOptions, enabledOptionsList, error, execCommand, execCommandParts, execOtherOptionStrings, lastError, milkee, milkeeOptions, options, spawnArgs, summary, toContinue;
  checkCoffee();
  if (!fs.existsSync(CONFIG_PATH)) {
    consola.error(`\`${CONFIG_FILE}\` not found in this directory: ${CWD}`);
    consola.info('Please run `milkee --setup` to create a configuration file.');
    process.exit(1);
  }
  try {
    config = require(CONFIG_PATH);
    if (!(config.entry && config.output)) {
      consola.error('`entry` and `output` properties are required in your configuration.');
      process.exit(1);
    }
    options = {...(config.options || {})};
    milkee = config.milkee || {};
    milkeeOptions = config.milkee.options || {};
    if (!milkeeOptions.ignoreUpdate) {
      await checkVersion();
    }
    execCommandParts = ['coffee'];
    if (options.join) {
      execCommandParts.push('--join');
      execCommandParts.push(`\"${config.output}\"`);
    } else {
      execCommandParts.push('--output');
      execCommandParts.push(`\"${config.output}\"`);
    }
    execOtherOptionStrings = [];
    if (options.bare) {
      execOtherOptionStrings.push('--bare');
    }
    if (options.map) {
      execOtherOptionStrings.push('--map');
    }
    if (options.inlineMap) {
      execOtherOptionStrings.push('--inline-map');
    }
    if (options.noHeader) {
      execOtherOptionStrings.push('--no-header');
    }
    if (options.transpile) {
      execOtherOptionStrings.push('--transpile');
    }
    if (options.literate) {
      execOtherOptionStrings.push('--literate');
    }
    if (execOtherOptionStrings.length > 0) {
      execCommandParts.push(execOtherOptionStrings.join(' '));
    }
    execCommandParts.push('--compile');
    execCommandParts.push(`\"${config.entry}\"`);
    execCommand = execCommandParts.filter(Boolean).join(' ');
    spawnArgs = [];
    if (options.join) {
      spawnArgs.push('--join');
      spawnArgs.push(config.output);
    } else {
      spawnArgs.push('--output');
      spawnArgs.push(config.output);
    }
    if (options.bare) {
      spawnArgs.push('--bare');
    }
    if (options.map) {
      spawnArgs.push('--map');
    }
    if (options.inlineMap) {
      spawnArgs.push('--inline-map');
    }
    if (options.noHeader) {
      spawnArgs.push('--no-header');
    }
    if (options.transpile) {
      spawnArgs.push('--transpile');
    }
    if (options.literate) {
      spawnArgs.push('--literate');
    }
    if (options.watch) {
      spawnArgs.push('--watch');
    }
    spawnArgs.push('--compile');
    spawnArgs.push(config.entry);
    summary = [];
    summary.push(`Entry: \`${config.entry}\``);
    summary.push(`Output: \`${config.output}\``);
    enabledOptions = Object.keys(options).filter(function(key) {
      return options[key];
    });
    if (enabledOptions.length > 0) {
      enabledOptionsList = enabledOptions.join(',');
      summary.push(`Options: ${enabledOptionsList}`);
    }
    consola.box({
      title: 'Milkee Compilation Summary',
      message: summary.join('\n')
    });
    if (milkeeOptions.confirm) {
      toContinue = (await confirmContinue());
      if (!toContinue) {
        return;
      }
    }
    delete options.join;
    backupFiles = [];
    if (milkeeOptions.refresh) {
      try {
        await executeRefresh(config, backupFiles);
      } catch (error1) {
        error = error1;
        restoreBackups(backupFiles);
        process.exit(1);
      }
    }
    if (options.watch) {
      consola.start(`Watching for changes in \`${config.entry}\`...`);
      consola.info(`Executing: coffee ${spawnArgs.join(' ')}`);
      if (milkeeOptions.refresh) {
        consola.warn('Refresh backup is disabled in watch mode (backups are cleared immediately).');
        clearBackups(backupFiles);
      }
      compilerProcess = spawn('coffee', spawnArgs, {
        shell: true
      });
      debounceTimeout = null;
      lastError = null;
      compilerProcess.stderr.on('data', function(data) {
        var errorMsg;
        errorMsg = data.toString().trim();
        if (errorMsg) {
          consola.error(errorMsg);
          return lastError = errorMsg;
        }
      });
      compilerProcess.stdout.on('data', function(data) {
        var stdoutMsg;
        stdoutMsg = data.toString().trim();
        if (stdoutMsg) {
          consola.log(stdoutMsg);
        }
        debounceTimeout = null;
        lastError = null;
        if (debounceTimeout) {
          clearTimeout(debounceTimeout);
        }
        return debounceTimeout = setTimeout(function() {
          if (lastError) {
            consola.warn('Compilation failed, plugins skipped.');
          } else {
            consola.success('Compilation successful (watch mode).');
            runPlugins(config, {...(config.options || {})}, '(watch mode)', '');
          }
          return lastError = null;
        }, 100);
      });
      compilerProcess.on('close', function(code) {
        return consola.info(`Watch process exited with code ${code}.`);
      });
      return compilerProcess.on('error', function(err) {
        consola.error('Failed to start watch process:', err);
        return process.exit(1);
      });
    } else {
      consola.start(`Compiling from \`${config.entry}\` to \`${config.output}\`...`);
      consola.info(`Executing: ${execCommand}`);
      return compilerProcess = exec(execCommand, function(error, stdout, stderr) {
        if (error) {
          consola.error('Compilation failed:', error);
          if (stderr) {
            consola.error(stderr.toString().trim());
          }
          if (milkeeOptions.refresh) {
            restoreBackups(backupFiles);
          }
          process.exit(1);
          return;
        }
        if (stdout) {
          process.stdout.write(stdout);
        }
        if (stderr && !error) {
          process.stderr.write(stderr);
        }
        return setTimeout(async function() {
          if (milkeeOptions.refresh) {
            clearBackups(backupFiles);
            consola.success('Backup clearing completed!');
          }
          if (milkeeOptions.copy) {
            try {
              await executeCopy(config);
            } catch (error1) {
              error = error1;
              consola.error('Failed to copy non-coffee files');
              process.exit(1);
              return;
            }
          }
          consola.success('Compilation completed successfully!');
          // Run plugins after all milkee.options are completed
          return runPlugins(config, {...(config.options || {})}, stdout, stderr);
        }, 500);
      });
    }
  } catch (error1) {
    error = error1;
    consola.error('Failed to load or execute configuration:', error);
    return process.exit(1);
  }
};

module.exports = compile;
