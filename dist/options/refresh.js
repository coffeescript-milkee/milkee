// Generated by CoffeeScript 2.7.0
var CWD, clearBackups, consola, crypto, executeRefresh, fs, path, restoreBackups;

fs = require('fs');

path = require('path');

crypto = require('crypto');

consola = require('consola');

({CWD} = require('../lib/constants'));

// Execute refresh processing
executeRefresh = function(config, backupFiles) {
  var backupName, backupPath, dirName, error, fileName, hash, i, item, items, len, originalPath, stat, targetDir;
  targetDir = path.isAbsolute(config.output) ? config.output : path.join(CWD, config.output);
  if (fs.existsSync(targetDir)) {
    stat = fs.statSync(targetDir);
    hash = crypto.randomBytes(4).toString('hex');
    try {
      if (stat.isDirectory()) {
        consola.info("Executing: Refresh");
        items = fs.readdirSync(targetDir);
        consola.start("Backing up files...");
        for (i = 0, len = items.length; i < len; i++) {
          item = items[i];
          originalPath = path.join(targetDir, item);
          backupName = `${hash}.${item}.bak`;
          backupPath = path.join(targetDir, backupName);
          fs.renameSync(originalPath, backupPath);
          backupFiles.push({
            original: originalPath,
            backup: backupPath
          });
        }
        return consola.success(`Files backed up with hash \`${hash}\``);
      } else {
        consola.info("Executing: Refresh (Single File)");
        originalPath = targetDir;
        fileName = path.basename(originalPath);
        dirName = path.dirname(originalPath);
        backupName = `${hash}.${fileName}.bak`;
        backupPath = path.join(dirName, backupName);
        fs.renameSync(originalPath, backupPath);
        backupFiles.push({
          original: originalPath,
          backup: backupPath
        });
        return consola.success(`Existing file backed up as \`${backupName}\``);
      }
    } catch (error1) {
      error = error1;
      consola.error("Failed to create backups during refresh:", error);
      throw error;
    }
  } else {
    return consola.info("Refresh skipped.");
  }
};

// Restore backup files
restoreBackups = function(backupFiles) {
  var backup, e, i, len;
  consola.info("Restoring previous files...");
  if (backupFiles.length > 0) {
    for (i = 0, len = backupFiles.length; i < len; i++) {
      backup = backupFiles[i];
      try {
        if (fs.existsSync(backup.original)) {
          fs.rmSync(backup.original, {
            force: true
          });
        }
        if (fs.existsSync(backup.backup)) {
          fs.renameSync(backup.backup, backup.original);
        }
      } catch (error1) {
        e = error1;
        consola.warn(`Failed to restore ${backup.original}`);
      }
    }
    return consola.success("Restored!");
  } else {
    return consola.info("No files found to restore.");
  }
};

// Clear backup files
clearBackups = function(backupFiles) {
  var backup, e, i, len, results;
  if (backupFiles.length > 0) {
    consola.start("Cleaning up backups...");
    results = [];
    for (i = 0, len = backupFiles.length; i < len; i++) {
      backup = backupFiles[i];
      try {
        if (fs.existsSync(backup.backup)) {
          results.push(fs.rmSync(backup.backup, {
            force: true
          }));
        } else {
          results.push(void 0);
        }
      } catch (error1) {
        e = error1;
        results.push(null);
      }
    }
    return results;
  }
};

module.exports = {executeRefresh, restoreBackups, clearBackups};
